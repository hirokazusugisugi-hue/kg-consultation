# Googleフォーム日程アンケート v2 + LP改修 + LINE連携ニュース管理 要件定義

---

## 変更点サマリ

| 項目 | v1（現行） | v2（変更後） |
|------|-----------|-------------|
| アンケート方式 | オプトイン（参加可能日をチェック） | **オプトアウト（参加不可日をチェック）** |
| デフォルト | 全日程「不参加」 | **全日程「参加可能」** |
| 送信回数 | 月1回（25日） | **月2回（1回目:25日 + 2回目:翌月15日）** |
| 2回目の役割 | なし | **確定確認 + 追加参加の申告** |
| 予約済み枠の扱い | 考慮なし | **保護 + 管理者通知** |
| 条件未達枠 | LP表示のみ制御 | **自動クローズ + 確定レポート** |
| 日程枠 | 毎週土日 12:00-16:00 / 火金 19:00-20:00 | **第1・第3土日 14:00/16:00/18:00 / 第2・第4金曜 19:00/20:30 Zoomのみ** |
| LPカレンダー | 旧日程ハードコード | **新日程ルールに対応** |
| ニュース | HTMLハードコード | **LINE送信で動的更新** |

---

# Part A: 日程アンケートシステム

---

## A-1. 日程枠の定義

### 枠ルール

各相談枠は **1時間**。土日は枠間 **1時間**、金曜は枠間 **30分** の休憩を設ける。

| 曜日 | 時間帯 | 枠数 | 対応方法 | 備考 |
|------|--------|-----|---------|------|
| 第1・第3 土曜・日曜 | 14:00, 16:00, 18:00 | 3枠 | 両方（対面+オンライン） | 隔週（月2回の週末） |
| 第2・第4 金曜 | 19:00, 20:30 | 2枠 | **Zoomのみ** | 月2回のみ |

- 火曜日の枠は**廃止**
- 第2・第4・第5の土日は**なし**
- 第1・第3・第5金曜日の枠は**なし**
- 土日: 14:00開始〜18:00開始（最終枠 18:00-19:00、枠間1時間で3枠）
- 金曜: 19:00開始〜20:30開始（最終枠 20:30-21:30、枠間30分で2枠）

### 月あたりの最大枠数
- 土日: 3枠 x 4日（第1土・第1日・第3土・第3日）= **12枠**
- 金曜: 2枠 x 2日（第2金・第4金）= **4枠**
- 合計: 最大 **16枠/月**

### 第N週の判定ロジック
```
土日の判定（第1・第3）:
  月の1日から順に土曜日/日曜日をそれぞれカウント:
    1回目の土曜 = 第1土曜 → 対象
    2回目の土曜 = 第2土曜 → 対象外
    3回目の土曜 = 第3土曜 → 対象
    4回目以降 → 対象外
  ※ 日曜も同様に第1・第3のみ対象

金曜の判定（第2・第4）:
  月の1日から順に金曜日をカウント:
    1回目の金曜日 = 第1金曜 → 対象外
    2回目の金曜日 = 第2金曜 → 対象
    3回目の金曜日 = 第3金曜 → 対象外
    4回目の金曜日 = 第4金曜 → 対象
    5回目の金曜日 = 第5金曜 → 対象外
```

### 2026年4月の具体例
```
4/ 4(土) 第1土曜 → 対象  14:00 / 16:00 / 18:00
4/ 5(日) 第1日曜 → 対象  14:00 / 16:00 / 18:00
4/10(金) 第2金曜 → 対象  19:00 / 20:30 [Zoomのみ]
4/18(土) 第3土曜 → 対象  14:00 / 16:00 / 18:00
4/19(日) 第3日曜 → 対象  14:00 / 16:00 / 18:00
4/24(金) 第4金曜 → 対象  19:00 / 20:30 [Zoomのみ]

対象外: 4/11(土), 4/12(日), 4/25(土), 4/26(日), 4/3(金), 4/17(金)
合計: 16枠
```

---

## A-2. オプトアウト方式（1回目フォーム: 25日送信）

### 概要
- メンバーは **デフォルトで全日程に参加可能** として扱われる
- 1回目フォームでは **絶対に参加できない日時にチェック** を入れる
- 未回答のメンバーは「全日程参加可能」として登録される

### フォーム構造（2026年4月の例）
```
タイトル: 「2026年4月 参加不可日程の申告」

説明:
  デフォルトでは全日程に参加可能として登録されます。
  参加できない日時がある場合のみ、該当箇所にチェックを入れてください。
  全日程OKの方は回答不要です。
  再送信で修正可能です。

質問1: 4/4(土) → □14:00 □16:00 □18:00
質問2: 4/5(日) → □14:00 □16:00 □18:00
質問3: 4/10(金) [第2金曜・Zoomのみ] → □19:00 □20:30
質問4: 4/18(土) → □14:00 □16:00 □18:00
質問5: 4/19(日) → □14:00 □16:00 □18:00
質問6: 4/24(金) [第4金曜・Zoomのみ] → □19:00 □20:30

※ チェック = その時間帯は参加不可
※ 未チェック = 参加可能（デフォルト）
※ 全項目未チェックで送信 = 全日程参加可能
```

### 回答処理ロジック（processFormResponse）
```
1. 対象月の全行からそのメンバーをクリア（旧状態リセット）
2. 対象月の全行にメンバーを追加（デフォルト = 全参加）
3. チェックされた（不可）日時の行からメンバーを削除
4. 予約済み枠から削除された場合 → 管理者に警告通知
5. 変更行のスコア再計算
```

### 未回答者の処理
- 1回目のフォーム作成時に、全メンバーを対象月の全枠にデフォルト登録する
- フォーム回答があった場合のみ、不可枠を除外して上書き
- **未回答 = 全日程参加可能で確定**

---

## A-3. 確認+追加フォーム（2回目: 翌月15日送信）

### 概要
2回目は **確定確認** と **追加参加の申告** を行うフォーム。
1回目で不可としていた日に追加で参加可能になった場合に申告できる。

### フォーム構造（Googleフォームのセクション分岐を利用）
```
タイトル: 「2026年4月 日程確認・追加フォーム」

説明:
  1回目アンケートの結果を踏まえた最終確認です。
  変更がなければ「現在の内容でOK」を選んで送信してください。
  追加で参加可能になった日がある場合はチェックしてください。

━━ セクション1: 確認 ━━

質問1（ラジオボタン・必須）:
  「現在の登録状況を確認してください」
  ○ 現在の内容でOK（変更なし）  → セクション3（送信）へ
  ○ 追加で参加可能な日がある     → セクション2へ

━━ セクション2: 追加参加日の申告 ━━

説明: 追加で参加可能になった日時にチェックしてください。

質問2: 4/4(土) → □14:00 □16:00 □18:00
質問3: 4/5(日) → □14:00 □16:00 □18:00
質問4: 4/10(金) [第2金曜・Zoomのみ] → □19:00 □20:30
質問5: 4/18(土) → □14:00 □16:00 □18:00
質問6: 4/19(日) → □14:00 □16:00 □18:00
質問7: 4/24(金) [第4金曜・Zoomのみ] → □19:00 □20:30

※ チェック = 追加で参加可能に変更
※ 未チェック = 現状維持（1回目の内容のまま）

━━ セクション3: 送信 ━━
（送信ボタン）
```

### 回答処理ロジック（processConfirmationResponse）
```
1. 「現在の内容でOK」の場合:
   → 何もしない（現状維持で確定）

2. 「追加で参加可能な日がある」の場合:
   → チェックされた日時の行にメンバーを追加（既にいる場合はスキップ）
   → 変更行のスコア再計算
   ※ 削除は行わない（追加のみ）
```

### ポイント
- 2回目では **メンバーの削除は行わない**（追加のみ）
- 削除が必要な場合は1回目のフォームを再送信するか、管理者に連絡
- 「OKで確定」の簡単な導線を優先（ワンクリックで完了）

---

## A-4. 条件未達枠の自動クローズ

### 開催条件（既存のスコアルール）
```
開催可能（K列 = ○）:
  - 配置点数 >= 4（例: 診断士2名以上）
  - または 配置点数 >= 2 かつ 特別対応フラグ = TRUE

開催不可（K列 = ×）:
  - 上記を満たさない場合
```

### 確定処理フロー（`finalizeSchedule()` — 最終期限翌日の21日に実行）
```
1. 対象月の全枠を走査
2. K列（予約可能判定）= × の枠を特定
3. 該当枠のC列（対応可否）を「×」に変更
4. 管理者に確定結果レポートをメール送信:
   - 開催確定枠の一覧（○の枠）
   - 開催中止枠の一覧（×の枠 + 理由: メンバー不足）
   - 各枠の参加メンバー名と配置点数
```

### 管理者への確定レポートメール
```
件名: 【日程確定】2026年4月 開催枠の確定結果

2026年4月の日程アンケート結果を確定しました。

━━ 開催確定枠（10枠） ━━
4/4(土) 14:00  配置点数:6  メンバー: 杉山,川崎,小椋  ○
4/4(土) 16:00  配置点数:5  メンバー: 杉山,原,野田    ○
4/4(土) 18:00  配置点数:4  メンバー: 川崎,秋月       ○
...

━━ 開催中止枠（6枠） ━━
4/5(日) 18:00  配置点数:2  メンバー: 高乘,村本       × メンバー不足
4/10(金) 20:30 配置点数:1  メンバー: 野田           × メンバー不足
...

※ 開催確定枠のみLPに表示されます。
```

---

## A-5. 予約済み枠の保護

### 処理ルール

| 枠の状態 | メンバーの操作 | 処理 |
|---------|-------------|------|
| 空き | 1回目で不可チェック | 通常通りメンバーを削除 |
| 予約済み | 1回目で不可チェック | メンバーを削除 + **管理者に警告メール** |
| 空き | 2回目で追加チェック | メンバーを追加 |
| 予約済み | 2回目で追加チェック | メンバーを追加（通常処理） |

### 管理者への警告メール
```
件名: 【要確認】予約済み枠からのメンバー離脱

以下の予約済み枠から、メンバーが参加不可の申告をしました。
代替メンバーの確保が必要な場合があります。

対象枠: 2026/04/05 14:00
離脱メンバー: {メンバー名}
残りメンバー: {残りメンバー名}
現在の配置点数: {点数}
予約可能判定: {○ or ×}

※ 配置点数が不足する場合、LPから予約枠が非表示になります。
```

---

## A-6. メール文面

### 1回目メール（25日送信）
```
件名: 【日程アンケート】2026年4月 参加不可日の申告をお願いします

{名前} 様

{組織名}の日程調整アンケートです。

2026年4月の相談対応日程について、参加できない日時を申告してください。
全日程に参加可能な方は回答不要です（自動的に全枠参加として登録されます）。

▼ 回答フォーム
{URL}

回答期限: {期限日}
※ 回答後も期限内であれば再送信で修正可能です。
※ 3月15日に最終確認のご連絡をいたします。

よろしくお願いいたします。
{組織名}
```

### 2回目メール — 1回目未回答者向け（15日送信）
```
件名: 【最終確認】2026年4月 日程の確定確認

{名前} 様

2026年4月の日程について、1回目のアンケートにご回答がなかったため、
現在「全日程参加可能」として登録されています。

このまま確定してよい場合は「現在の内容でOK」を選択して送信してください。
参加できない日がある場合はお早めにお知らせください。

▼ 確認フォーム
{URL}

最終期限: {最終期限日}
※ 期限を過ぎると現在の登録内容で確定となります。

よろしくお願いいたします。
{組織名}
```

### 2回目メール — 1回目回答済み者向け（15日送信）
```
件名: 【最終確認】2026年4月 日程の確定確認

{名前} 様

2026年4月の日程について、ご回答ありがとうございました。

予定に変更がなければ「現在の内容でOK」を選択して送信してください。
追加で参加可能になった日がある場合はチェックして送信してください。

▼ 確認フォーム
{URL}

最終期限: {最終期限日}
※ 期限を過ぎると現在の登録内容で確定となります。

よろしくお願いいたします。
{組織名}
```

---

## A-7. 2回送信のスケジュール

| 回 | タイミング | 対象月 | 役割 | 例（4月分） |
|----|-----------|-------|------|------------|
| 1回目 | 毎月25日 | 翌々月 | 不可日の申告（オプトアウト） | 2月25日 |
| 2回目 | 翌月15日 | 翌月（同じ対象月） | 確定確認 + 追加参加の申告 | 3月15日 |
| 確定 | 翌月21日 | 同上 | 条件未達枠を自動クローズ | 3月21日 |

---

# Part B: LP（index14.html）の改修

---

## B-1. カレンダーのフォールバック日程を新ルールに変更

### 現状の問題
`useDefaultSchedule()` 関数が旧日程ルール（毎週土日 12:00-16:00、火金 19:00-20:00）でハードコードされている。
GAS APIが未設定の場合にこの旧日程が表示されてしまう。

### 変更内容
`useDefaultSchedule()` のロジックを新日程ルールに合わせる:

```javascript
// 変更前（旧ルール）
if (dow === 0 || dow === 6) {
    availableSchedule[dateKey] = [
        { time: '12:00' }, { time: '13:00' }, { time: '14:00' },
        { time: '15:00' }, { time: '16:00' }
    ];
} else if (dow === 2 || dow === 5) {
    availableSchedule[dateKey] = [
        { time: '19:00' }, { time: '20:00' }
    ];
}

// 変更後（新ルール）
// 第1・第3土日 → 14:00, 16:00, 18:00
// 第2・第4金曜 → 19:00, 20:30（Zoomのみ）
```

### 判定ロジック（JavaScript）
```javascript
function getNthDayOfWeek(year, month, day, dow) {
    // その月の中でdow曜日が何回目かを返す
    let count = 0;
    for (let d = 1; d <= day; d++) {
        if (new Date(year, month, d).getDay() === dow) count++;
    }
    return count;
}

// 土日: 第1・第3のみ
if (dow === 0 || dow === 6) {
    const nth = getNthDayOfWeek(year, month, day, dow);
    if (nth === 1 || nth === 3) {
        availableSchedule[dateKey] = [
            { time: '14:00' }, { time: '16:00' }, { time: '18:00' }
        ];
    }
}
// 金曜: 第2・第4のみ
if (dow === 5) {
    const nth = getNthDayOfWeek(year, month, day, dow);
    if (nth === 2 || nth === 4) {
        availableSchedule[dateKey] = [
            { time: '19:00' }, { time: '20:30' }
        ];
    }
}
```

### 注意
- GAS APIが正常動作している場合はスプレッドシートのデータが優先される
- このフォールバックはAPI未設定時のみ使われる
- 対面選択時に金曜枠を非表示にするロジックは既存のまま（金曜はZoomのみ）

---

## B-2. ニュースバーの動的化

### 現状
```html
<!-- 現在: HTMLにハードコード -->
<span class="news-text">2026.04.01 — 無料経営相談の本格運用を開始しました。</span>
```

### 変更後
LP読み込み時にGAS APIからニュースデータを取得し、動的に表示する。

### LP側JavaScript
```javascript
// ページ読み込み時にニュースを取得
async function fetchNews() {
    try {
        const response = await fetch(GAS_API_URL + '?action=news');
        const data = await response.json();
        if (data.success && data.news && data.news.length > 0) {
            const latest = data.news[0]; // 最新の1件
            document.querySelector('.news-text').textContent =
                latest.date + ' — ' + latest.content;
        }
    } catch (e) {
        // 取得失敗時は既存テキストをそのまま表示
        console.log('ニュース取得スキップ');
    }
}
```

### GAS API（doGet に追加）
```javascript
// action=news で最新ニュースを返す
if (action === 'news') {
    const news = getLatestNews();
    return ContentService.createTextOutput(JSON.stringify({
        success: true,
        news: news
    })).setMimeType(ContentService.MimeType.JSON);
}
```

---

# Part C: 管理用Webページによるニュース管理

---

## C-1. 概要

GASのWebアプリ機能で **管理用ページ** を提供する。
管理者がブラウザでURLを開き、フォームからニュースを追加・編集・削除できる。
スマホのブックマークからもアクセス可能。

### フロー
```
管理者がブックマークURLを開く
  → 管理用ページが表示（現在のニュース一覧 + 投稿フォーム）
  → 日付・内容を入力して「投稿」ボタン
  → 「お知らせ」シートに保存
  → LPがGAS APIから取得して表示（即時反映）
```

---

## C-2. 管理用ページの画面構成

### アクセスURL
```
{GAS WebアプリURL}?action=news-admin
```
※ 既存の doGet に `action=news-admin` を追加して管理ページを返す

### 画面レイアウト
```
┌─────────────────────────────────────┐
│  お知らせ管理                        │
├─────────────────────────────────────┤
│                                     │
│  ▼ 新規投稿                         │
│  ┌─────────────────────────────┐   │
│  │ 日付: [2026.05.01      ]    │   │
│  │ 内容: [                  ]   │   │
│  │         [     投稿する    ]   │   │
│  └─────────────────────────────┘   │
│                                     │
│  ▼ 現在のお知らせ一覧                 │
│  ┌─────────────────────────────┐   │
│  │ 1. 2026.04.25              │   │
│  │    5月度の相談枠を公開       │   │
│  │    [表示中] [非表示にする]    │   │
│  ├─────────────────────────────┤   │
│  │ 2. 2026.04.01              │   │
│  │    無料経営相談の本格運用開始  │   │
│  │    [表示中] [非表示にする]    │   │
│  ├─────────────────────────────┤   │
│  │ 3. 2026.03.15              │   │
│  │    テスト運用を開始          │   │
│  │    [非表示] [表示にする] [削除]│   │
│  └─────────────────────────────┘   │
│                                     │
│  ▼ プレビュー                       │
│  ┌─────────────────────────────┐   │
│  │ News 2026.05.01 — 5月度の… │   │
│  └─────────────────────────────┘   │
│  ※ LP上の表示イメージ               │
│                                     │
└─────────────────────────────────────┘
```

### 機能一覧

| 操作 | 説明 |
|------|------|
| 新規投稿 | 日付（デフォルト: 今日）と内容を入力して追加 |
| 表示/非表示切り替え | 表示フラグのON/OFFをワンクリックで切り替え |
| 削除 | 非表示のお知らせを完全削除（確認ダイアログ付き） |
| プレビュー | 現在LPに表示される最新ニュースのプレビュー |

---

## C-3. GAS側の実装

### doGet への追加ルーティング
```javascript
// 管理ページ表示
if (action === 'news-admin') {
    return generateNewsAdminPage();
}

// ニュース取得API（LP用）
if (action === 'news') {
    const news = getLatestNews();
    return ContentService.createTextOutput(JSON.stringify({
        success: true,
        news: news
    })).setMimeType(ContentService.MimeType.JSON);
}

// ニュース操作API（管理ページから呼ばれる）
if (action === 'news-add') {
    addNews(e.parameter.date, e.parameter.content);
    return redirect('news-admin');
}
if (action === 'news-toggle') {
    toggleNewsVisibility(e.parameter.row);
    return redirect('news-admin');
}
if (action === 'news-delete') {
    deleteNews(e.parameter.row);
    return redirect('news-admin');
}
```

### 管理ページ生成関数
```javascript
function generateNewsAdminPage() {
    // HtmlServiceでHTML生成
    // お知らせシートのデータを読み込み
    // フォーム + 一覧 + プレビューを含むHTMLを返す
    return HtmlService.createHtmlOutput(html)
        .setTitle('お知らせ管理');
}
```

---

## C-4. お知らせシート（スプレッドシート）

### シート名
`お知らせ`

### 列定義

| 列 | 項目 | 例 |
|----|------|-----|
| A | 日付 | 2026.05.01 |
| B | 内容 | 5月度の相談枠を公開しました |
| C | 表示フラグ | TRUE / FALSE |
| D | 作成日時 | 2026/04/25 10:30:00 |

### config.gs に追加
```javascript
NEWS_SHEET_NAME: 'お知らせ',
```

### 列定義（config.gs に追加）
```javascript
const NEWS_COLUMNS = {
    DATE: 0,       // A: 日付
    CONTENT: 1,    // B: 内容
    VISIBLE: 2,    // C: 表示フラグ
    CREATED_AT: 3  // D: 作成日時
};
```

---

## C-5. ニュース取得API（LP用）

### エンドポイント
`GET ?action=news`

### レスポンス
```json
{
    "success": true,
    "news": [
        {
            "date": "2026.05.01",
            "content": "5月度の相談枠を公開しました"
        },
        {
            "date": "2026.04.01",
            "content": "無料経営相談の本格運用を開始しました"
        }
    ]
}
```

### 取得ロジック
- お知らせシートから `表示フラグ = TRUE` の行を取得
- 日付の降順（新しい順）でソート
- 最大10件を返却

---

## C-6. 将来的な拡張（保留）

以下は今後必要に応じて追加可能:

| 拡張 | 内容 |
|------|------|
| LINE連携 | LINEメッセージでニュース投稿（`#news ...`コマンド） |
| 予約投稿 | 指定日時にニュースを自動公開 |
| カテゴリ | お知らせの種類分け（ニュース / メンテナンス / 重要） |

---

# Part D: 設定・トリガー・ファイル一覧

---

## D-1. 設定値（config.gs）

```javascript
// フォームポーリング設定
FORM_POLLING: {
    FIRST_SEND_DAY: 25,       // 1回目送信日（毎月N日）
    FIRST_SEND_HOUR: 10,      // 1回目送信時刻
    REMINDER_SEND_DAY: 15,    // 2回目（確認）送信日（翌月N日）
    REMINDER_SEND_HOUR: 10,   // 2回目送信時刻
    FINALIZE_DAY: 21,         // 日程確定日（翌月N日）
    FINALIZE_HOUR: 10,        // 日程確定時刻
    FIRST_DEADLINE_DAYS: 18,  // 1回目の回答期限（25日→翌月15日の約18日後）
    FINAL_DEADLINE_DAYS: 5    // 2回目の最終期限（送信からN日後）
},

// お知らせシート名
NEWS_SHEET_NAME: 'お知らせ',
```

---

## D-2. トリガー構成

| トリガー | タイミング | ハンドラ関数 |
|---------|-----------|-------------|
| 月次1回目 | 毎月25日 10:00 | `runFirstPolling()` |
| 月次2回目 | 毎月15日 10:00 | `runReminderPolling()` |
| 日程確定 | 毎月21日 10:00 | `finalizeSchedule()` |
| フォーム送信（1回目） | フォーム回答時 | `processFormResponse(e)` |
| フォーム送信（2回目） | フォーム回答時 | `processConfirmationResponse(e)` |
| onEdit | シート編集時 | `onSheetEdit(e)`（既存） |
| 日次リマインド | 毎日 9:00 | `sendDailyReminders()`（既存） |

※ ニュース管理はトリガー不要（管理ページからのリクエストで処理）

---

## D-3. データ保存（PropertiesService）

```javascript
// 1回目フォーム作成時に保存
PropertiesService.getScriptProperties().setProperty(
    'polling_form_2026_4',
    JSON.stringify({
        formId: 'xxx',
        formUrl: 'https://...',
        editUrl: 'https://...',
        targetYear: 2026,
        targetMonth: 4,
        createdAt: '2026-02-25T10:00:00',
        round: 1
    })
);

// 2回目フォーム作成時に追加保存
PropertiesService.getScriptProperties().setProperty(
    'polling_confirm_form_2026_4',
    JSON.stringify({
        formId: 'yyy',
        formUrl: 'https://...',
        targetYear: 2026,
        targetMonth: 4,
        createdAt: '2026-03-15T10:00:00',
        round: 2
    })
);
```

---

## D-4. 運用タイムライン（例: 2026年4月分）

| 日付 | イベント |
|------|---------|
| 2/25 | **1回目**: 4月分の日程生成（16枠）+ 全メンバー自動登録 + オプトアウトフォーム作成 + メール送信 |
| 2/25〜3/14 | メンバーがフォーム回答（不可日を申告）。未回答者は全枠参加のまま |
| 3/15 | **2回目**: 確認+追加フォーム作成 + メール送信（未回答者/回答済み者で文面分け） |
| 3/15〜3/20 | 最終確認期間（OKで確定 or 追加参加を申告） |
| 3/21 | **日程確定**: 条件未達枠を自動クローズ + 管理者に確定レポート送信 |
| 3/21以降 | 開催確定枠のみLP上で予約可能枠として表示 |
| 随時 | 管理者が管理ページからニュース投稿 → LP即時反映 |
| 4/1〜 | 相談者が予約 → 通常フロー |

---

## D-5. 対象ファイル一覧

| ファイル | 変更種別 | 変更内容 |
|---------|---------|---------|
| `gas/form_polling.gs` | **全面書き換え** | オプトアウト + 確認+追加フォーム + 2回送信 + 予約保護 + 自動クローズ |
| `gas/config.gs` | 修正 | FORM_POLLING拡張 + NEWS_SHEET_NAME + NEWS_COLUMNS追加 |
| `gas/schedule.gs` | 修正 | 日程生成ロジック変更（第1・第3土日 + 第2・第4金曜） |
| `gas/triggers.gs` | 修正 | 2回目+確定トリガー追加 |
| `gas/main.gs` | 修正 | doGet に `action=news` / `action=news-admin` 等を追加 |
| `gas/news.gs` | **新規作成** | お知らせシート操作 + 管理ページHTML生成（addNews / getLatestNews / toggleNewsVisibility / deleteNews / generateNewsAdminPage / setupNewsSheet） |
| `index14.html` | 修正 | カレンダーフォールバック新日程化 + ニュースバー動的取得 |

※ `gas/members.gs` は変更なし（getMemberByEmail は実装済み）

---

## D-6. フォーム回答処理の詳細フロー

### 1回目フォーム回答処理（processFormResponse）
```
1. LockServiceで排他制御開始
2. メールアドレスからメンバー特定（getMemberByEmail）
3. 対象月の全行からそのメンバーをクリア（旧状態リセット）
4. 対象月の全行にメンバーを追加（デフォルト = 全参加）
5. チェックされた（不可）日時の行からメンバーを削除
   - 削除対象が「予約済み」枠の場合 → 警告リストに追加
6. 警告リストがあれば管理者にメール通知
7. 変更行のスコア再計算（recalculateScheduleScoreForRow）
8. 排他制御解放
```

### 2回目フォーム回答処理（processConfirmationResponse）
```
1. LockServiceで排他制御開始
2. メールアドレスからメンバー特定（getMemberByEmail）
3. 確認質問の回答を取得
   - 「現在の内容でOK」→ 処理終了（現状維持で確定）
   - 「追加で参加可能な日がある」→ 続行
4. チェックされた（追加参加可能）日時の行にメンバーを追加
   - 既にメンバーがいる場合はスキップ
5. 変更行のスコア再計算
6. 排他制御解放
```

### ニュース管理ページの操作フロー
```
管理者アクセス: {GAS URL}?action=news-admin

新規投稿:
  1. 日付と内容を入力して「投稿する」ボタン
  2. → ?action=news-add&date=...&content=... でGASに送信
  3. → お知らせシートに行を追加（表示フラグ = TRUE）
  4. → 管理ページにリダイレクト（一覧が更新される）
  5. → LPは次回読み込み時にAPIから最新データを取得

表示/非表示切り替え:
  1. 一覧の「非表示にする」/「表示にする」ボタン
  2. → ?action=news-toggle&row=N でGASに送信
  3. → C列（表示フラグ）をTRUE⇔FALSE切り替え
  4. → 管理ページにリダイレクト

削除:
  1. 非表示のお知らせの「削除」ボタン（確認ダイアログ付き）
  2. → ?action=news-delete&row=N でGASに送信
  3. → お知らせシートから行を削除
  4. → 管理ページにリダイレクト
```
