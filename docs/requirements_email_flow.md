# メール送信フロー要件定義

## 概要

相談方法（対面 / オンライン Zoom）に応じて、メール送信フローを分岐させる。
Zoom相談はNDA同意完了時に自動確定し、対面相談は会場確保後に手動確定する。

---

## フロー比較

### 対面相談（計4通 + リマインド）

| # | タイミング | メール件名 | 送信方法 | 内容 |
|---|-----------|-----------|----------|------|
| 1 | 申込直後 | 【受付完了】 | 自動 | 申込内容確認 + 同意書リンク + 「会場確保後3日以内に確定メール送付」の案内 |
| 2 | NDA同意完了時 | 【同意完了】 | 自動 | 同意受領確認 + 「会場確保中。確定メールをお待ちください」 |
| 3 | 会場確保・ステータス「確定」変更時 | 【予約確定】 | 手動トリガー | 確定日時・会場・担当者・当日の流れ |
| 4 | 3日前 / 前日 | リマインドメール | 自動（日次トリガー） | 準備案内 / 最終確認 |
| - | 相談終了後 | アンケートメール | 自動 | アンケート依頼 |

### オンライン相談・Zoom（計3通 + リマインド）

| # | タイミング | メール件名 | 送信方法 | 内容 |
|---|-----------|-----------|----------|------|
| 1 | 申込直後 | 【受付完了】 | 自動 | 申込内容確認 + 同意書リンク + 「同意完了後に確定メール送付」の案内 |
| 2 | NDA同意完了時 | 【予約確定】 | 自動 | 同意受領 + 予約確定（1通に統合）。確定日時・Zoom URL・当日の流れ |
| 3 | 3日前 / 前日 | リマインドメール | 自動（日次トリガー） | 準備案内 / 最終確認 |
| - | 相談終了後 | アンケートメール | 自動 | アンケート依頼 |

---

## システム変更点

### 1. 受付確認メール（templates.gs: `getConfirmationEmailBody`）
- 「次のステップ」セクションを相談方法で分岐
  - **対面**: 「会場確保後、3日以内に予約確定メールをお送りいたします」
  - **Zoom**: 「同意完了後、予約確定メールをお送りいたします」

### 2. NDA同意処理（nda.gs: `processNdaConsent`）
- 同意完了後に相談方法を判定
  - **Zoom（かつ確定日時あり）**:
    - ステータスを「確定」に自動変更
    - 日程設定シートの予約状況を「予約済み」に更新
    - 同意完了＋確定メールを1通で送信（`sendConsentAndConfirmedEmail`）
    - 管理者に「自動確定」通知（`notifyConsentAgreedAutoConfirmed`）
    - 担当者に確定通知
  - **対面**:
    - ステータスは「NDA同意済」のまま
    - 同意完了メールに「会場確保中」の案内を記載
    - 管理者に「会場確保依頼」通知（`notifyConsentAgreed`）

### 3. 予約確定メール（既存: `handleStatusChange` → `sendConfirmedEmail`）
- 対面の場合のみ使用（Zoomは自動確定時に送信済み）
- 管理者がスプレッドシートで場所を設定し、ステータスを「確定」に変更した時に発火

### 4. 管理者通知の分岐（nda.gs）
- **対面**: `notifyConsentAgreed` - 「会場を確保してステータスを確定にしてください」
- **Zoom**: `notifyConsentAgreedAutoConfirmed` - 「自動確定しました。Zoom URLが未設定の場合は前日までに設定してください」

---

## ステータス遷移

### 対面相談
```
仮予約 → NDA同意済 → [会場確保] → 確定 → 完了
```

### Zoom相談
```
仮予約 → 確定（NDA同意で自動遷移） → 完了
```

---

## 追加された関数

| 関数名 | ファイル | 説明 |
|--------|---------|------|
| `sendConsentAndConfirmedEmail(data)` | nda.gs | Zoom用：同意完了＋自動確定メール送信 |
| `notifyConsentAgreedAutoConfirmed(data, signature)` | nda.gs | Zoom用：管理者への自動確定通知 |

## 変更された関数

| 関数名 | ファイル | 変更内容 |
|--------|---------|---------|
| `getConfirmationEmailBody(data, consentUrl)` | templates.gs | 次のステップを対面/Zoom分岐 |
| `processNdaConsent(e)` | nda.gs | Zoom時の自動確定ロジック追加 |
| `sendConsentConfirmationToApplicant(data)` | nda.gs | 対面用に「会場確保中」メッセージ追加 |
| `notifyConsentAgreed(data, signature)` | nda.gs | 対面用に「会場確保依頼」メッセージ追加 |

---

## 注意事項

- Zoom自動確定は `data.confirmedDate` が存在する場合のみ発動
  - 確定日時が未設定の場合はNDA同意済のまま、管理者の手動確定を待つ
- Zoom URLは確定時点で未設定の可能性がある（「前日までにお送りします」と案内）
- 当日受付（コード9999）は既存フローのまま（確定済みで登録される）
- 対面の場合、管理者は会場確保後にN列（場所）を設定してから「確定」に変更する必要がある

---

*作成日: 2026年2月*
*最終更新: 2026年2月*
